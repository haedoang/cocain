<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.cocain.repository.mapper.UserMapper">
	<resultMap id="userMap" type="user">
		<result column="id" property="id" />
		<result column="password" property="password" />
		<result column="nickname" property="nickname" />
		<result column="email" property="email" />
		<result column="point" property="point"/>
		<result column="reg_date" property="regDate" />
		<association property="userFile"
					 column="id"
					 select="selectFile"></association>
	</resultMap>
	
	<resultMap id="userFileMap" type="userFile">
		<result column="id" property="id" />
		<result column="fileName" property="fileName" />
		<result column="uploadPath" property="uploadPath" />
	</resultMap> 
	
	<resultMap id="recentActivityMap" type="recentActivity">
		<result column="no" property="no" />
		<result column="title" property="title" />
		<result column="writer" property="writer" />
		<result column="typeqna" property="typeqna" />
		<result column="reg_date" property="regDate" />
	</resultMap> 
	
	<!-- 회원 등록 -->
	<insert id="registerUser" parameterType="user">
		insert into tb_user(
			id, password, nickname, email
		) values (
			#{id}, #{password}, #{nickname}, #{email}
		)
	</insert>
	
	<!-- 아이디 중복 체크 -->
	<select id="checkId" parameterType="user" resultType="int">
		select count(*)
		  from tb_user
		 where id = #{id} 
	</select>
	
	<!-- 닉네임 중복 체크 -->
	<select id="checkName" parameterType="user" resultType="int">
		select count(*)
		  from tb_user
		 where nickname = #{nickname} 
	</select>
	
	<!-- 로그인 -->
	<select id="userLogin" parameterType="user" resultMap="userMap">
		select * 
		  from tb_user
		 where id = #{id}
	</select>
	
	<!-- 현재 비밀번호 체크 -->
	<select id="checkPass" parameterType="string" resultMap="userMap">
		select * 
		  from tb_user
		 where id = #{id}
	</select>
	
	<!-- 비밀번호 수정 -->
	<update id="updatePass" parameterType="user">
		update tb_user 
		   set password = #{password}
		 where id = #{id}
	</update>
	
	<!-- 파일 등록 -->
 	<insert id="insertFile" parameterType="userFile">
		insert into tb_user_file (
			id, fileName, uploadPath
		) values (
			#{id}, #{fileName}, #{uploadPath}
		)
	</insert>
	
	<!-- 파일 삭제 -->
 	<delete id="deleteFile" parameterType="userFile">
		delete from tb_user_file 
		 where id = #{id}
	</delete> 
	
	<!-- 아이디에 따른 파일정보 검색 -->
 	<select id="selectFile" parameterType="userFile" resultMap="userFileMap">
		select * from tb_user_file
		 where id = #{id}
	</select> 
	
	<!-- 유저 최근활동 리스트 -->
 	<select id="userRecentActivity" parameterType="recentActivity" resultMap="recentActivityMap">
		select no, title, writer, typeqna, reg_date 
		  from(select no, title, writer, 'typeqna', reg_date from tb_qna
		        union
			   select no, title, id, 'typestudy', reg_date from tb_study
			 	union 
			   select quiz_no, title, nickname, 'typequiz', reg_date from tb_quiz_board
			    union
			   select no, content, writer, 'typeqnacm', reg_date from tb_qna_comment) b 
		  where writer = #{writer}
		  order by reg_date desc
     	  limit #{begin}, 5
	</select> 
	
	<!-- 유저 최근활동 리스트 갯수 -->
 	<select id="userRecentActivityCount" parameterType="recentActivity" resultType="int">
		select count(*) 
		  from(select no, title, writer, 'typeqna', reg_date from tb_qna
		        union
				 select no, title, id, 'typestudy', reg_date from tb_study
			 	  union 
			 	 select quiz_no, title, nickname, 'typequiz', reg_date from tb_quiz_board
				  union 
			 	 select no, content, writer, 'typeqnacm', reg_date from tb_qna_comment) b 
		  where writer = #{writer}
	</select>
	
	<!-- 전체 게시물 수 -->
	<select id="allArticleCount" resultType="int">
		select count(*) 
	 	 from(select no, title, writer from tb_qna
	     	   union
		  	  select no, title, id from tb_study
		 	   union 
		 	  select quiz_no, title, nickname from tb_quiz_board
			   union 
		 	  select no, title, writer from tb_notice) b
	</select> 	  
	
	<!-- 전체 문제 수 -->
	<select id="allQuizCount" resultType="int">
		select count(*) from tb_quiz_board
	</select> 
		  	  
</mapper>

























